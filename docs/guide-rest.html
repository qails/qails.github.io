<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>RESTful APIs | Qails</title><meta name="viewport" content="width=device-width"><link rel="shortcut icon" href="/images/favicon.png"><link rel="stylesheet" href="/css/qails.css"><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/es6-shim/0.34.4/es6-shim.min.js"></script></head><body><div class="container"><div class="nav-main"><div class="wrap"><a class="nav-home" href="/"><img src="/images/qails-logo-white.png" alt="qails logo">Qails</a><div class="nav-site-wrapper"><ul class="nav-site nav-site-internal"><li><a href="/docs/basic-getting-started.html" class="active" data-target=".nav-docs">文档</a></li></ul><ul class="nav-site nav-site-external"><li><a href="https://github.com/qails" class="">GitHub</a></li><li><a href="https://packingjs.github.io" class="">Packing</a></li></ul></div></div></div><section class="content wrap documentationContent"><div class="nav-docs"><div class="nav-docs-viewport"><div class="nav-docs-section"><h3>基础知识</h3><ul><li><a style="margin-left:10px;" class="" href="/docs/basic-getting-started.html#content">概述</a></li><li><a style="margin-left:10px;" class="" href="/docs/basic-installation.html#content">安装</a></li><li><a style="margin-left:10px;" class="" href="/docs/basic-structure.html#content">目录结构</a></li><li><a style="margin-left:10px;" class="" href="/docs/basic-commands.html#content">命令</a></li><li><a style="margin-left:10px;" class="" href="/docs/basic-httpd.html#content">HTTP 服务器</a></li><li><a style="margin-left:10px;" class="" href="/docs/basic-middlewares.html#content">内置中间件</a></li><li><a style="margin-left:10px;" class="" href="/docs/basic-util.html#content">内置util方法</a></li></ul></div><div class="nav-docs-section"><h3>使用指南</h3><ul><li><a style="margin-left:10px;" class="" href="/docs/guide-configuration.html#content">profile 配置</a></li><li><a style="margin-left:10px;" class="" href="/docs/guide-router.html#content">路由</a></li><li><a style="margin-left:10px;" class="" href="/docs/guide-orm.html#content">对象关系映射</a></li><li><a style="margin-left:10px;" class="active" href="/docs/guide-rest.html#content">RESTful APIs</a></li><li><a style="margin-left:10px;" class="" href="/docs/guide-graphql.html#content">GraphQL APIs</a></li><li><a style="margin-left:10px;" class="" href="/docs/guide-test.html#content">单元测试</a></li><li><a style="margin-left:10px;" class="" href="/docs/guide-log.html#content">日志</a></li><li><a style="margin-left:10px;" class="" href="/docs/guide-es6.html#content">使用 ES6</a></li><li><a style="margin-left:10px;" class="" href="/docs/guide-jenkins.html#content">用 Jenkins 发布</a></li><li><a style="margin-left:10px;" class="" href="/docs/guide-changelog.html#content">Chanagelog</a></li></ul></div><div class="nav-docs-section"><h3>中间件</h3><ul><li><a style="margin-left:10px;" class="" href="/docs/middleware-accesslog.html#content">accessLogMiddleware</a></li><li><a style="margin-left:10px;" class="" href="/docs/middleware-bodyparser.html#content">bodyParserMiddleware</a></li><li><a style="margin-left:10px;" class="" href="/docs/middleware-cors.html#content">corsMiddleware</a></li><li><a style="margin-left:10px;" class="" href="/docs/middleware-envelope.html#content">envelopeMiddleware</a></li><li><a style="margin-left:10px;" class="" href="/docs/middleware-graphql.html#content">graphqlMiddleware</a></li><li><a style="margin-left:10px;" class="" href="/docs/middleware-prettyjson.html#content">prettyJsonMiddleware</a></li><li><a style="margin-left:10px;" class="" href="/docs/middleware-serve.html#content">serveMiddleware</a></li></ul></div><div class="nav-docs-section"><h3>util方法</h3><ul><li><a style="margin-left:10px;" class="" href="/docs/util-pug.html#content">pug</a></li><li><a style="margin-left:10px;" class="" href="/docs/util-session.html#content">session</a></li><li><a style="margin-left:10px;" class="" href="/docs/util-requireAllRouters.html#content">requireAllRouters</a></li><li><a style="margin-left:10px;" class="" href="/docs/util-watcher.html#content">watcher</a></li></ul></div><div class="nav-docs-section"><h3>示例代码</h3><ul><li><a style="margin-left:10px;" class="" href="/docs/example-helloworld.html#content">Hello World</a></li><li><a style="margin-left:10px;" class="" href="/docs/example-commonprofile.html#content">Common Profile</a></li><li><a style="margin-left:10px;" class="" href="/docs/example-buildinsmiddlewares.html#content">Buildins Middlewares</a></li><li><a style="margin-left:10px;" class="" href="/docs/example-mixedmiddlewares.html#content">Mixed Middlewares</a></li><li><a style="margin-left:10px;" class="" href="/docs/example-rest.html#content">RESTful APIs</a></li><li><a style="margin-left:10px;" class="" href="/docs/example-graphql.html#content">GraphQL APIs</a></li></ul></div></div></div><div class="inner-content"><a id="content"></a><h1>RESTful APIs</h1><div><p>qails能根据model自动创建RESTful路由地址，该功能由 <code>qails/util/resource.js</code> 提供。</p><h2><a class="anchor" name="resourcerouter-define-model-options"></a>ResourceRouter.define(model, options) <a class="hash-link" href="#resourcerouter-define-model-options">#</a></h2><p>根据模型创建 CRUD 路由，ResourceRouter 继承了 koa-router。</p><h3><a class="anchor" name=""></a>参数 <a class="hash-link" href="#">#</a></h3><ul><li>model {bookshelf.model} 模型</li><li>options<ul><li><strong>setup</strong>: {function} 路由创建方法，默认为 <code>router.crud()</code>，即自动创建 CRUD 方法</li><li><strong>prefix</strong>: {string} 前缀，如 <code>/api</code>，默认为空</li><li><strong>root</strong>: {string} 路由根路径，默认为模型的 <code>tableName</code></li></ul></li></ul><h2><a class="anchor" name="crud"></a>创建一个最简单的CRUD路由 <a class="hash-link" href="#crud">#</a></h2><pre class="prism language-javascript">
import <span class="token punctuation">{</span> Resource <span class="token punctuation">}</span> from <span class="token string">&#x27;qails&#x27;</span><span class="token punctuation">;</span>
import Role from <span class="token string">&#x27;../models/roles&#x27;</span><span class="token punctuation">;</span>

export default Resource<span class="token punctuation">.</span><span class="token function">define<span class="token punctuation">(</span></span>Role<span class="token punctuation">)</span><span class="token punctuation">;</span></pre><p>上面的代码会自动创建以下路由：</p><table><thead><tr><th>提交方式</th><th>路由</th><th>说明</th></tr></thead><thead><tr><td>POST</td><td>/roles</td><td>新建一个角色</td></tr><tr><td>GET</td><td>/roles</td><td>列出所有角色</td></tr><tr><td>GET</td><td>/roles/:id</td><td>获取某个指定角色的信息</td></tr><tr><td>PATCH</td><td>/roles/:id</td><td>更新某个指定角色的信息</td></tr><tr><td>DELETE</td><td>/roles/:id</td><td>删除某个角色</td></tr></thead></table><h2><a class="anchor" name="cru"></a>创建一个CRU路由(不包含删除) <a class="hash-link" href="#cru">#</a></h2><pre class="prism language-javascript">
import <span class="token punctuation">{</span> Resource <span class="token punctuation">}</span> from <span class="token string">&#x27;qails&#x27;</span><span class="token punctuation">;</span>
import Role from <span class="token string">&#x27;../models/roles&#x27;</span><span class="token punctuation">;</span>

export default Resource<span class="token punctuation">.</span><span class="token function">define<span class="token punctuation">(</span></span>Role<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">setup<span class="token punctuation">(</span></span>router<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    router<span class="token punctuation">.</span><span class="token function">create<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><p>上面的代码会自动创建以下路由：</p><table><thead><tr><th>提交方式</th><th>路由</th><th>说明</th></tr></thead><thead><tr><td>POST</td><td>/roles</td><td>新建一个角色</td></tr><tr><td>GET</td><td>/roles</td><td>列出所有角色</td></tr><tr><td>GET</td><td>/roles/:id</td><td>获取某个指定角色的信息</td></tr><tr><td>PATCH</td><td>/roles/:id</td><td>更新某个指定角色的信息</td></tr></thead></table><h2><a class="anchor" name=""></a>创建带前缀的路由 <a class="hash-link" href="#">#</a></h2><pre class="prism language-javascript">
import <span class="token punctuation">{</span> Resource <span class="token punctuation">}</span> from <span class="token string">&#x27;qails&#x27;</span><span class="token punctuation">;</span>
import Role from <span class="token string">&#x27;../models/roles&#x27;</span><span class="token punctuation">;</span>

export default Resource<span class="token punctuation">.</span><span class="token function">define<span class="token punctuation">(</span></span>Role<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  prefix<span class="token punctuation">:</span> <span class="token string">&#x27;/api&#x27;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><p>上面的代码会自动创建以下路由：</p><table><thead><tr><th>提交方式</th><th>路由</th><th>说明</th></tr></thead><thead><tr><td>POST</td><td>/api/roles</td><td>新建一个角色</td></tr><tr><td>GET</td><td>/api/roles</td><td>列出所有角色</td></tr><tr><td>GET</td><td>/api/roles/:id</td><td>获取某个指定角色的信息</td></tr><tr><td>PATCH</td><td>/api/roles/:id</td><td>更新某个指定角色的信息</td></tr><tr><td>DELETE</td><td>/api/roles/:id</td><td>删除某个角色</td></tr></thead></table><h2><a class="anchor" name=""></a>创建和表名称不一样的路由 <a class="hash-link" href="#">#</a></h2><pre class="prism language-javascript">
import <span class="token punctuation">{</span> Resource <span class="token punctuation">}</span> from <span class="token string">&#x27;qails&#x27;</span><span class="token punctuation">;</span>
import Role from <span class="token string">&#x27;../models/roles&#x27;</span><span class="token punctuation">;</span>

export default Resource<span class="token punctuation">.</span><span class="token function">define<span class="token punctuation">(</span></span>Role<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  root<span class="token punctuation">:</span> <span class="token string">&#x27;jiaose&#x27;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><p>上面的代码会自动创建以下路由：</p><table><thead><tr><th>提交方式</th><th>路由</th><th>说明</th></tr></thead><thead><tr><td>POST</td><td>/jiaose</td><td>新建一个角色</td></tr><tr><td>GET</td><td>/jiaose</td><td>列出所有角色</td></tr><tr><td>GET</td><td>/jiaose/:id</td><td>获取某个指定角色的信息</td></tr><tr><td>PATCH</td><td>/jiaose/:id</td><td>更新某个指定角色的信息</td></tr><tr><td>DELETE</td><td>/jiaose/:id</td><td>删除某个角色</td></tr></thead></table><h2><a class="anchor" name="crud"></a>在标准 CRUD 路由前后插入其他中间件 <a class="hash-link" href="#crud">#</a></h2><p>有时候需要在标准的路由前后加入一些业务规则中间件，如新增一条记录后需要在日志表中记录操作人日志，这时候可以在创建路由时注入中间件。可以在以下位置注入中间件：</p><table><thead><tr><th>参数名称</th><th>参数类型</th><th>适用patten</th><th>说明</th></tr></thead><thead><tr><td>beforeMiddlewaves</td><td><code>Function</code> <code>Array</code></td><td>all</td><td>在标准路由前执行</td></tr><tr><td>afterMiddlewaves</td><td><code>Function</code> <code>Array</code></td><td>all</td><td>在标准路由后执行</td></tr><tr><td>beforeListMiddlewaves</td><td><code>Function</code> <code>Array</code></td><td>/models</td><td>在标准获取列表路由前执行</td></tr><tr><td>afterListMiddlewaves</td><td><code>Function</code> <code>Array</code></td><td>/models</td><td>在标准获取列表路由后执行</td></tr><tr><td>beforeItemMiddlewaves</td><td><code>Function</code> <code>Array</code></td><td>/models/:model</td><td>在标准获取详情路由前执行</td></tr><tr><td>afterItemMiddlewaves</td><td><code>Function</code> <code>Array</code></td><td>/models/:model</td><td>在标准获取详情路由后执行</td></tr></thead></table><pre class="prism language-javascript">
import <span class="token punctuation">{</span> Resource <span class="token punctuation">}</span> from <span class="token string">&#x27;qails&#x27;</span><span class="token punctuation">;</span>
import Log from <span class="token string">&#x27;../models/log&#x27;</span><span class="token punctuation">;</span>

export default Resource<span class="token punctuation">.</span><span class="token function">define<span class="token punctuation">(</span></span>Log<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">setup<span class="token punctuation">(</span></span>router<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    router<span class="token punctuation">.</span><span class="token function">read<span class="token punctuation">(</span></span><span class="token punctuation">{</span>
      beforeMiddlewaves<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token function">async<span class="token punctuation">(</span></span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">&#x27;===before===&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          await <span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      afterMiddlewaves<span class="token punctuation">:</span> <span class="token function">async<span class="token punctuation">(</span></span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">&#x27;===after===&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        await <span class="token function">next<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><h2><a class="anchor" name=""></a>查询路由支持的查询参数 <a class="hash-link" href="#">#</a></h2><p>可以在查询列表的接口中通过 <code>querystring</code> 参数控制返回结构，支持的控制参数有：</p><ul><li><strong>withRelated</strong>: {string} 获取关联数据，多个用逗号隔开</li><li><strong>where</strong>: 查询条件，支持以下几种传值方式<ul><li>{string} 多个条件有逗号隔开，3个一组 <code>where=id,&gt;,10,name,like,%abc%</code></li><li>{object} <code>where[id]=10</code></li><li>{array} <code>where=id&amp;where==&amp;where=10</code></li></ul></li><li><strong>andWhere</strong>: {string} and查询条件，用法同 where</li><li><strong>orWhere</strong>: {string} or查询条件，用法同 where</li><li><strong>sort</strong>: {string} 排序，默认正序，减号开头表示倒序，多个用逗号隔开</li><li><strong>page</strong>: {int} 当前页码</li><li><strong>pageSize</strong>: {int} 每页记录数，和 page 成为一组分页控制参数</li><li><strong>limit</strong>: {int} 控制返回记录数量</li><li><strong>first</strong>: {int} 同 limit</li><li><strong>offset</strong>: {int} 记录偏移量，和 limit 成为一组分页控制参数</li><li><strong>mask</strong>: {string} 只返回mask列出的字段</li></ul><h2><a class="anchor" name="model"></a>创建一个表名称和model名称不一致的路由 <a class="hash-link" href="#model">#</a></h2><p>假设表名称是 <code>tb_roles</code>，希望创建的路由是 <code>roles</code>，这需要在创建路由时指定 <code>name</code> 参数：</p><pre class="prism language-javascript">
<span class="token comment" spellcheck="true">// routes/role.js
</span>import <span class="token punctuation">{</span> Resource <span class="token punctuation">}</span> from <span class="token string">&#x27;qails&#x27;</span><span class="token punctuation">;</span>
import Role from <span class="token string">&#x27;../models/role&#x27;</span><span class="token punctuation">;</span>

export default Resource<span class="token punctuation">.</span><span class="token function">define<span class="token punctuation">(</span></span>Role<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">&#x27;roles&#x27;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre><p>同时指定 model 名称</p><pre class="prism language-javascript">
<span class="token comment" spellcheck="true">// models/role.js
</span>import <span class="token punctuation">{</span> Model <span class="token punctuation">}</span> from <span class="token string">&#x27;qails&#x27;</span><span class="token punctuation">;</span>

export default class <span class="token class-name">extends</span> Model <span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token function">tableName<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&#x27;tb_roles&#x27;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div><div class="docs-prevnext"><a class="docs-next" href="guide-graphql.html#content">Next →</a></div><p class="edit-page-block">如果你发现文档存在错误，请<a target="_blank" href="https://github.com/qails/qails/issues">在 GitHub 提个 issue</a> 告诉我们。</p></div></section><footer class="nav-footer"><a href="https://qails.github.io" target="_blank" class="fbOpenSource"><img src="/images/qails-logo-white.png" alt="qails" width="45" height="45"></a><section class="copyright">Copyright © 2017 Qails Team.</section></footer></div><div id="fb-root"></div><script src="/js/scripts.js"></script></body></html>